{% extends 'administration/layout_admin.html.twig' %}

{% block title %}
    Activité | {{ activity.name }}
    <input id="activityId" type="hidden" value="{{ activity.id }}">
{% endblock %}

{% block body %}
    <div class="row justify-content-center">
        <button class="btn btn-outline-dark" id="allEmails">Copier mails des participants à cette activité</button>
    </div>
    <br> <br> <br>

    <input id="timeSlotsSize" type="hidden" value="{{ timeSlots|length }}">
    {% for timeSlot in timeSlots %}
        <div class="row">
            <h4 style="text-decoration: underline">{{ timeSlot.getFullTime }}</h4>
        </div>

        <br>
        <div class="row">
            <div class="col text-right">
                <h5> Nombre de particiants : <span
                            style="color:red; text-align: right"> {{ timeSlot.getAdherentsNumber }} </span></h5>
            </div>

            <div class="col">
                <input type="hidden" name="timeSlot" id="timeSlotId{{ loop.index0 }}" value="{{ timeSlot.id }}"/>
                <button id="TimeSlotAdherentsEmailsButton{{ loop.index0 }}" class="btn btn-outline-dark"> Copier mails
                    des
                    participants à ce créneau
                </button>
            </div>
        </div>

        <br>
        <div class="row justify-content-center" style="width: 100%">
            <div class="col-5">
                <a class="btn btn-outline-info" data-toggle="collapse" href="#collapseExample{{ timeSlot.id }}"
                   role="button"
                   aria-expanded="false" aria-controls="collapseExample" style="width: 100%">
                    Voir et ajouter de nouveaux adhérents
                </a>
            </div>
        </div>
        <br/> <br/>

        <div class="collapse" id="collapseExample{{ timeSlot.id }}">
            <div class="card card-body">
                <div class="container">
                    <br/>
                    <h2 align="center">Adhérents déjà associés au créneau : </h2>

                    <table id="adherentsTimeSlot{{ timeSlot.id }}" class="table table-striped table-bordered"
                           style="width: 100%;"
                           role="grid"
                           aria-describedby="example_info">
                        <thead>
                        <tr role="row">
                            <th class="sorting_asc" tabindex="0" aria-controls="example" rowspan="1" colspan="1"
                                style="width: 119px;" aria-sort="ascending"
                                aria-label="lastName: activate to sort column descending">Nom
                            </th>
                            <th class="sorting_asc" tabindex="0" aria-controls="example" rowspan="1" colspan="1"
                                style="width: 119px;" aria-sort="ascending"
                                aria-label="firstName: activate to sort column descending">Prénom
                            </th>
                            <th class="sorting_asc" tabindex="0" aria-controls="example" rowspan="1" colspan="1"
                                style="width: 119px;" aria-sort="ascending"
                                aria-label="firstName: activate to sort column descending">Statut de l'inscription
                            </th>
                            <th class="sorting_asc" tabindex="0" aria-controls="example" rowspan="1" colspan="1"
                                style="width: 119px;" aria-sort="ascending"
                                aria-label="firstName: activate to sort column descending">Actions
                            </th>
                        </tr>
                        </thead>
                        <tbody>

                        {% for adherent in timeSlot.getAdherents %}
                            {% if adherent.isDeleted == false %}
                                <tr role="row" class="odd">
                                    <td>
                                        {{ adherent.lastName }}
                                    </td>
                                    <td>
                                        {{ adherent.firstName }}
                                    </td>
                                    <td>
                                        {{ adherent.status }}
                                    </td>

                                    <td>
                                        <a href="{{ path('admin_activityDeleteAdherentFromTimeSlot', {activityId: activity.id, timeSlotId: timeSlot.id, adherentId: adherent.id}) }}"
                                           class="btn btn-danger"> Supprimer </a>
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                        </tbody>
                        <tfoot>
                        <tr>
                            <th rowspan="1" colspan="1">Nom</th>
                            <th rowspan="1" colspan="1">Prénom</th>
                            <th rowspan="1" colspan="1">Statut de l'inscription</th>
                            <th rowspan="1" colspan="1">Actions</th>
                        </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <br/>
            <div class="card card-body">
                <div class="container">
                    <div class="row justify-content-center">
                        <h4>Ajouter de nouveaux adhérents</h4>
                    </div>

                    <div class="row">
                        <form style="width:100%" method="post" id="form{{ loop.index0 }}"
                              action={{ path('admin_activityAddAdherentToTimeSlot') }}>
                            <select style="width: 100%" class="js-example-basic-multiple{{ loop.index0 }}"
                                    name="states[]"
                                    multiple="multiple">
                                {% for adherent in adherents %}
                                    {% if not timeSlot.contains(adherent) %}
                                        <option value="{{ adherent.id }}">{{ adherent.lastName }} {{ adherent.firstName }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                            <input type="hidden" name="hidden_framework" class="hidden_framework"/>
                            <input type="hidden" name="timeSlot" id="timeSlotId" value="{{ timeSlot.id }}"/>
                            <input type="hidden" name="activity" id="activityId" value="{{ activity.id }}"/>
                            <div class="row justify-content-center">
                                <input type="submit" name="submit" class="btn btn-outline-success" value="Submit"/>
                            </div>
                        </form>
                        <br/>
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}
{% endblock %}


{% block javascripts %}
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.7/css/select2.min.css"
          rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.7/js/select2.min.js"></script>

    <script>
        // In your Javascript (external .js resource or <script> tag)
        $(document).ready(function () {
            var timeSlotsSize = $('#timeSlotsSize').val();

            for (var i = 0; i < timeSlotsSize; i++) {
                $("#button" + i).on('click', function (event) {
                    console.log(event);
                    var id = event.currentTarget.attr('data-id');
                    console.log(id);
                });
            }

            for (var i = 0; i < timeSlotsSize; i++) {
                $('.js-example-basic-multiple' + i).select2();
            }

            function generateH(j) {
                return function (event) {
                    $('.hidden_framework').val($('.js-example-basic-multiple' + j).val());
                };
            }

            for (var i = 0; i <= timeSlotsSize; i++) {
                $('.js-example-basic-multiple' + i).change(generateH(i));
            }

            function copyTextToClipBoard(data) {
                var tempInput = document.createElement("input");
                tempInput.style = "position: absolute; left: -1000px; top: -1000px";
                tempInput.value = data;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand("copy");
                document.body.removeChild(tempInput);
                alert("Copie effectuée");
            }

            function generateMailsReceptionHandler(j) {
                return function (event) {
                    event.preventDefault();
                    var t = j;
                    var timeSlotId = $("#timeSlotId" + j).val();
                    $.ajax({
                        url: "{{ path('admin_activityCopyTimeSlotEmails') }}",
                        method: "POST",
                        data: {timeSlotId: timeSlotId},
                        success: function (data) {
                            copyTextToClipBoard(data);
                        }
                    })
                }
            }

            for (var i = 0; i < timeSlotsSize; i++) {
                $('#TimeSlotAdherentsEmailsButton' + i).on('click', generateMailsReceptionHandler(i));
            }

            $('#allEmails').on('click', function (event) {
                var activityId = $("#activityId").val();
                event.preventDefault();
                $.ajax({
                    url: "{{ path('admin_activityCopyAllEmails') }}",
                    method: "POST",
                    data: {activityId: activityId},
                    dataType: "json",
                    success: function (data) {
                        copyTextToClipBoard(data);
                    }
                })
            });
        });
    </script>
{% endblock %}
